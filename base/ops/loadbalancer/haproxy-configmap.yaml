kind: ConfigMap
apiVersion: v1
metadata:
  namespace: loadbalancer
  name: haproxy-config
data:
  haproxy.cfg: |
    global
      log stdout format raw local0 info
      stats socket ipv4@127.0.0.1:9999 level admin
      stats socket /var/run/hapee-lb.sock mode 666 level admin
      stats timeout 2m

    defaults
      log               global
      option            httplog
      retries           3
      maxconn           2000
      timeout connect   5s
      timeout client    50s
      timeout server    50s

    frontend http_in
      bind *:80
      mode http
      option forwardfor
      option http-keep-alive
      default_backend jitsi-meet

    peers mypeers
      log stdout format raw local0 info
      peer "${HOSTNAME}" "${MY_POD_IP}:1024"
      peer "${OTHER_HOSTNAME}" "${OTHER_IP}:1024"

    backend jitsi-meet
      balance roundrobin
      mode http
      option forwardfor
      http-reuse safe
      http-request set-header Room %[urlp(room)]
      acl room_found urlp(room) -m found
      stick-table type string len 128 size 2k expire 1d peers mypeers
      stick on hdr(Room) if room_found
      server shard-0 web.jitsi-0.svc.cluster.local:80
      server shard-1 web.jitsi-1.svc.cluster.local:80