kind: ConfigMap
apiVersion: v1
metadata:
  namespace: loadbalancer
  name: haproxy-config
data:
  haproxy.cfg: |
    global
      log stdout format raw local0

    defaults
      log               global
      retries           3
      maxconn           2000
      timeout connect   5s
      timeout client    50s
      timeout server    50s
    
    frontend http_in
      bind *:80
      mode http
      option forwardfor
      option http-keep-alive
      option httplog
      default_backend jitsi-meet
    
    peers mypeers
      peer haproxy-0 haproxy-0:1024
      peer haproxy-1 haproxy-1:1024

    backend jitsi-meet
      balance roundrobin
      mode http
      option forwardfor
      http-reuse safe
      http-request set-header Room %[urlp(room)]
      acl room_found urlp(room) -m found
      stick-table type string len 128 size 2k expire 1d peers mypeers
      stick on hdr(Room) if room_found
      server shard-0 web.jitsi-0.svc.cluster.local:80
      server shard-1 web.jitsi-1.svc.cluster.local:80